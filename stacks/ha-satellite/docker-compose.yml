version: "3.8"

services:
  snapclient:
    build:
      context: ../../
      dockerfile: images/snapclient/Dockerfile-alpine
    image: local/snapclient:latest
    container_name: ha-snapclient
    restart: unless-stopped
    devices:
      - /dev/snd:/dev/snd
    group_add:
      - "29"
    ipc: host
    volumes:
      - /etc/asound.conf:/etc/asound.conf:ro
      - /dev/snd:/dev/snd
      - /dev/shm:/dev/shm
    environment:
      - TZ=Europe/Berlin
    command: >
      snapclient --player alsa 
      --soundcard ${ALSA_SNAP_DEVICE} 
      --hostID ${SATELLITE_NAME}-pi 
      tcp://${SNAPSERVER_HOST}:${SNAPSERVER_PORT}
    networks: [ha-audio]

  openwakeword:
    image: rhasspy/wyoming-openwakeword:latest
    container_name: ha-openwakeword
    restart: unless-stopped
    group_add:
      - "29"
    volumes:
      - ${WAKEWORD_DATA}:/data
    environment:
      - TZ=Europe/Berlin
    ports:
      - "10400:10400"
    networks: [ha-audio]

  ha-satellite:
    build:
      context: ../../
      dockerfile: images/wyoming-satellite/Dockerfile
    image: wyoming-satellite:local
    container_name: ha-satellite
    restart: unless-stopped
    depends_on:
      - openwakeword
      - ha-satellite-leds
    devices:
      - /dev/snd:/dev/snd
    group_add:
      - "29"
    ipc: host
    environment:
      - TZ=Europe/Berlin
    volumes:
      - /etc/asound.conf:/etc/asound.conf:ro
    # Hier nutzen wir Variablen fÃ¼r Name, Mic und Snd-Device
    command: >
      python3 -m wyoming_satellite
      --name "${SATELLITE_NAME}"
      --uri "tcp://0.0.0.0:10700"
      --event-uri "tcp://ha-satellite-leds:10500"
      --mic-command "arecord -D ${ALSA_MIC_DEVICE} -r 16000 -c 1 -f S16_LE -t raw"
      --snd-command "aplay -D ${ALSA_SND_DEVICE} -r 22050 -c 1 -f S16_LE -t raw"
      --mic-noise-suppression 2
      --mic-auto-gain 5
      --vad
      --vad-threshold 0.4
      --vad-wake-word-timeout 10
      --wake-word-name "hey_jarvis"
      --wake-uri "tcp://openwakeword:10400"
      --debug
    ports:
      - "10700:10700"
    networks: [ha-audio]

  ha-satellite-leds:
     build:
      context: ../../
      dockerfile: images/wyoming-satellite-leds/Dockerfile
    image: wyoming-satellite-leds:local
    container_name: ha-satellite-leds
    restart: unless-stopped
    devices:
      - /dev/spidev0.0:/dev/spidev0.0
      - /dev/spidev0.1:/dev/spidev0.1
      - /dev/gpiomem:/dev/gpiomem
      - /dev/gpiochip0:/dev/gpiochip0
      - /dev/gpiochip1:/dev/gpiochip1
      - /dev/gpiochip4:/dev/gpiochip4
    environment:
      - TZ=Europe/Berlin
    working_dir: /app
    volumes:
      - ${LED_EXAMPLES}:/app/examples:ro
    command: ["--uri", "tcp://0.0.0.0:10500"]
    networks: [ha-audio]

networks:
  ha-audio:
    driver: bridge
